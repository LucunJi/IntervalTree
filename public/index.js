(()=>{"use strict";const e=jQuery,t=JXG;function i(e,t){return Math.random()*(t-e)+e}function o(e){return e.point1.coords.usrCoords[1]<e.point2.coords.usrCoords[1]?{left:e.point1,right:e.point2}:{left:e.point2,right:e.point1}}function r(e){var t=o(e);return{left:t.left.coords.usrCoords[1],right:t.right.coords.usrCoords[1],range:t.right.coords.usrCoords[1]-t.left.coords.usrCoords[1]}}function s(e,t){var i=o(e),r=i.left.coords.usrCoords[1];return t>i.right.coords.usrCoords[1]?-1:t<r?1:0}var n=function(){function e(){this.paletteIdx=0}return e.prototype.get=function(){var t=e.PALETTE[this.paletteIdx%e.PALETTE.length];return this.paletteIdx++,t},e.PALETTE=["#bc0101","#ffd700","#ea5f94","#ff7300","#11b716","#10d5a8","#0000ff","#9d02d7"],e}(),d="#0072b2",h="#c25010",u="#1f1f1f",a="#1f1f1f",c=function(){function e(e){var i=this;this.acceptChanges=!0,this.segments=[],this.sortingEnd="left",this.medians={},this.segmentVisibleMedians={},this.newSegmentListeners=[],this.queryLineChangeListeners=[],this.startAddingSegmentFunction=function(e){if(!(i.board.getAllObjectsUnderMouse(e).length>0)){var t=i.board.getUsrCoordsOfMouse(e);i.creatingLine=i.newSegment(t,t)}},this.moveEndpointWhenAddingFunction=function(e){if(void 0!==i.creatingLine){var t=i.board.getUsrCoordsOfMouse(e);i.creatingLine.p1.setPosition(JXG.COORDS_BY_USER,[i.creatingLine.p1.coords.usrCoords[1],t[1]]),i.creatingLine.p2.setPosition(JXG.COORDS_BY_USER,t),i.board.update()}},this.releaseAddingSegmentFunction=function(){i.creatingLine=void 0},this.board=t.JSXGraph.initBoard(e,{boundingbox:[-10,10,10,-10],showCopyright:!1,showNavigation:!1,pan:{enabled:!1},zoom:{wheel:!1}}),this.board.on("down",this.startAddingSegmentFunction),this.board.on("move",this.moveEndpointWhenAddingFunction),this.board.on("up",this.releaseAddingSegmentFunction),this.queryLine=this.board.create("line",[[0,0],[0,1]],{visible:!1,fixed:!1,strokeColor:"#000",dragToTopOfLayer:!0,strokeOpacity:.5,strokeWidth:3}),this.queryLine.on("up",(function(){return i.notifyQueryLineChange(i.queryLine.point1.coords.usrCoords[1])}))}return e.prototype.newSegment=function(e,t){if(!this.acceptChanges)throw new Error("Board is frozen, new segments are not accepted.");var i=this.board.create("point",e,{withLabel:!1,color:h}),o=this.board.create("point",t,{withLabel:!1,color:h}),r=this.board.create("segment",[i,o],{strokeColor:d});return i.on("drag",(function(){return o.setPosition(JXG.COORDS_BY_USER,[o.coords.usrCoords[1],i.coords.usrCoords[2]])})),o.on("drag",(function(){return i.setPosition(JXG.COORDS_BY_USER,[i.coords.usrCoords[1],o.coords.usrCoords[2]])})),this.segments.push(r),this.segmentVisibleMedians[r.id]=[],this.notifyNewSegment(i,o,r),{p1:i,p2:o,l:r}},e.prototype.sortSegments=function(){var e=this;if(1===this.segments.length){var t=0;return(d=this.segments[0]).point1.moveTo([d.point1.coords.usrCoords[1],t],400),void d.point2.moveTo([d.point2.coords.usrCoords[1],t],400)}for(var i=[],o=[],s=0;s<this.segments.length;s++)i.push(s);for("left"===this.sortingEnd?i.sort((function(t,i){return r(e.segments[t]).left-r(e.segments[i]).left})):i.sort((function(t,i){return r(e.segments[i]).right-r(e.segments[t]).right})),s=0;s<this.segments.length;s++)o[i[s]]=s;var n=18/(this.segments.length-1);for(s=0;s<this.segments.length;s++){var d=this.segments[s];t=9-n*o[s],d.point1.moveTo([d.point1.coords.usrCoords[1],t],400),d.point2.moveTo([d.point2.coords.usrCoords[1],t],400)}},e.prototype.finalizeChanges=function(){if(this.acceptChanges){this.acceptChanges=!1,this.board.off("down",this.startAddingSegmentFunction),this.board.off("move",this.moveEndpointWhenAddingFunction),this.board.off("up",this.releaseAddingSegmentFunction),this.board.suspendUpdate();for(var e=0;e<this.segments.length;e++){var t=this.segments[e];t.setAttribute({strokeColor:u,fixed:!0}),t.point1.setAttribute({color:a,fixed:!0}),t.point2.setAttribute({color:a,fixed:!0})}this.board.unsuspendUpdate(),this.sortSegments()}},e.prototype.onNewSegment=function(e){this.newSegmentListeners.push(e)},e.prototype.notifyNewSegment=function(e,t,i){for(var o=0,r=this.newSegmentListeners;o<r.length;o++)(0,r[o])(e,t,i)},e.prototype.getSegments=function(){return this.segments},e.prototype.populateSegments=function(e){var t=-9.5,o=9.5;if(1!==e){for(var r=18/(e-1),s=0;s<e;s++)for(n=r*s-9;;)if(d=i(t,o),h=i(t,o),!(Math.abs(d-h)<.76)){this.newSegment([d,n],[h,n]);break}}else for(var n=0;;){var d=i(t,o),h=i(t,o);if(!(Math.abs(d-h)<.76)){this.newSegment([d,n],[h,n]);break}}},e.prototype.addMedian=function(e,t,i,o,r){return void 0===o&&(o=!1),void 0===r&&(r=e),void 0===this.medians[r]&&(this.medians[r]={line:this.board.create("line",[[e,0],[e,1]],{strokeColor:i,dash:2,visible:!1,fixed:!0}),relatedSegments:t,color:i},this.setMedianVisible(r,o),!0)},e.prototype.removeMedian=function(e){return void 0!==this.medians[e]&&(this.setMedianVisible(e,!1),this.board.removeObject(this.medians[e].line),delete this.medians[e],!0)},e.prototype.setMedianVisible=function(e,t){var i=this.medians[e];if(void 0!==i&&this.medians[e].line.getAttribute("visible")!==t){this.board.suspendUpdate(),i.line.setAttribute({visible:t});for(var o=0,r=i.relatedSegments;o<r.length;o++){var s=r[o];t?this.segmentVisibleMedians[s.id].push(e):this.segmentVisibleMedians[s.id]=this.segmentVisibleMedians[s.id].filter((function(t){return t!==e}));var n=this.segmentVisibleMedians[s.id],c=this.acceptChanges?d:u,l=this.acceptChanges?h:a;n.length>0&&(c=l=this.medians[n[n.length-1]].color),s.setAttribute({strokeColor:c}),s.point1.setAttribute({color:l}),s.point2.setAttribute({color:l})}this.board.unsuspendUpdate()}},e.prototype.setSortingEnd=function(e){this.sortingEnd!==e&&(this.sortingEnd=e,this.acceptChanges||this.sortSegments())},e.prototype.showQueryLine=function(){this.queryLine.setAttribute({visible:!0}),this.notifyQueryLineChange(this.queryLine.point1.coords.usrCoords[1])},e.prototype.onQueryLineChange=function(e){this.queryLineChangeListeners.push(e)},e.prototype.notifyQueryLineChange=function(e){for(var t=0,i=this.queryLineChangeListeners;t<i.length;t++)(0,i[t])(e)},e}(),l=function(){function e(){this.state="add",this.listeners=[]}return e.prototype.onChange=function(e){this.listeners.push(e)},e.prototype.setState=function(e){if(this.state!==e){var t=this.state;this.state=e;for(var i=0,o=this.listeners;i<o.length;i++)(0,o[i])(e,t)}},e.prototype.next=function(){"add"===this.state?this.setState("build"):"build"===this.state&&this.setState("query")},e}(),p=function(){function e(e){this.nodes=[];var t=e.slice(),i=e.slice();t.sort((function(e,t){return o(e).left.coords.usrCoords[1]-o(t).left.coords.usrCoords[1]})),i.sort((function(e,t){return o(t).right.coords.usrCoords[1]-o(e).right.coords.usrCoords[1]})),this.root=this.makeNode(void 0,t,i,0),this.height=this.root.height}return e.prototype.makeNode=function(e,t,i,r){var n=t.length;if(0!==n){for(var d={parent:e,childLeft:void 0,childRight:void 0,depth:void 0===e?0:e.depth+1,height:1,peerIdx:r,median:0,segmentsLeftSorted:[],segmentsRightSorted:[]},h=0,u=n-1,a=0;a<n;){var c=h>=n?void 0:o(t[h]).left.coords.usrCoords[1],l=u<0?void 0:o(i[u]).right.coords.usrCoords[1];void 0===l||c<l?(d.median=c,h++):(d.median=l,u--),a++}for(var p=[],f=[],g=[],v=[],b=0,m=t;b<m.length;b++)((L=s(S=m[b],d.median))<0?p:L>0?g:d.segmentsLeftSorted).push(S);for(var N=0,y=i;N<y.length;N++){var S,L;((L=s(S=y[N],d.median))<0?f:L>0?v:d.segmentsRightSorted).push(S)}return d.childLeft=this.makeNode(d,p,f,2*r),d.childRight=this.makeNode(d,g,v,2*r+1),void 0!==d.childLeft&&(d.height=d.childLeft.height+1),void 0!==d.childRight&&(d.height=Math.max(d.height,d.childRight.height+1)),this.nodes[(1<<d.depth)-1+d.peerIdx]=d,d}},e}(),f=function(){function e(e,i){var o=this;this.nodes=[],this.edges=[],this.simulationMode="build",this.hoverNodeEventListeners=[],this.recursionUpdateListeners=[],this.board=t.JSXGraph.initBoard(e,{boundingbox:[-10,10,10,-10],showCopyright:!1,drag:{enabled:!1},pan:{enabled:!0,needShift:!1,needTwoFingers:!1},zoom:{wheel:!0,needShift:!1}}),this.tree=new p(i),this.drawTree(),this.initSimulation(),this.board.on("move",(function(){var e=o.hoveringNode;o.hoveringNode=void 0;for(var t=0;t<o.nodes.length;t++){var i=o.nodes[t];if(void 0!==i&&i.mouseover){o.hoveringNode=o.tree.nodes[t];break}}o.hoveringNode!==e&&o.notifyHoverNodeEvent({node:o.hoveringNode,prevNode:e})}))}return e.prototype.drawTree=function(){var e=this;if(1!==this.tree.height){for(var t=16/(this.tree.height-1),i=this.tree.nodes.map((function(e,t){return void 0===e?void 0:t})).filter((function(e){return void 0!==e})).sort((function(t,i){return e.tree.nodes[t].median-e.tree.nodes[i].median})),o=[],r=new n,s=0,d=i;s<d.length;s++)o[l=d[s]]=r.get();for(var h=0;h<this.tree.height;h++)for(var u=8-h*t,a=1<<h,c=19/(a+1),l=0;l<a;l++){var p=a-1+l;f=[c*(l+1)-9.5,u],void 0!==this.tree.nodes[p]&&(this.nodes[p]=this.board.create("point",f,{size:.5,sizeUnit:"user",withLabel:!1,strokeWidth:4,color:o[p]}),p>0&&(this.edges[p]=this.board.create("line",[this.nodes[p],this.nodes[p-1>>>1]],{straightFirst:!1,straightLast:!1})))}}else{var f=[0,0];this.nodes[0]=this.board.create("point",f,{size:.5,sizeUnit:"user",withLabel:!1,strokeWidth:4,color:(new n).get()})}},e.prototype.initSimulation=function(){"build"===this.simulationMode?(this.setNodeAncestorsVisible(this.tree.root,!0),this.setChildrenVisible(this.tree.root,!1),this.prevNode=void 0,this.currNode=this.tree.root,this.focusNode(this.currNode)):"query"===this.simulationMode&&this.setSubtreeVisible(this.tree.root,!0),this.notifyRecursionUpdate({currNode:this.currNode,prevNode:this.prevNode})},e.prototype.setNodeAncestorsVisible=function(e,t){for(var i,o;void 0!==e;){var r=(1<<e.depth)-1+e.peerIdx;null===(i=this.nodes[r])||void 0===i||i.setAttribute({visible:t}),null===(o=this.edges[r])||void 0===o||o.setAttribute({visible:t}),e=e.parent}},e.prototype.setChildrenVisible=function(e,t){this.setSubtreeVisible(null==e?void 0:e.childLeft,t),this.setSubtreeVisible(null==e?void 0:e.childRight,t)},e.prototype.setSubtreeVisible=function(e,t){var i,o;if(void 0!==e){var r=(1<<e.depth)-1+e.peerIdx;null===(i=this.nodes[r])||void 0===i||i.setAttribute({visible:t}),null===(o=this.edges[r])||void 0===o||o.setAttribute({visible:t}),this.setSubtreeVisible(e.childLeft,t),this.setSubtreeVisible(e.childRight,t)}},e.prototype.setNodeHollow=function(e,t){var i;void 0!==e&&(null===(i=this.graphNode(e))||void 0===i||i.setAttribute({fillOpacity:t?0:1}))},e.prototype.focusNode=function(e){this.setNodeHollow(this.focusedNode,!1),this.setNodeHollow(this.focusedNode=e,!0)},e.prototype.graphNode=function(e){return this.nodes[(1<<e.depth)-1+e.peerIdx]},e.prototype.setSimulationMode=function(e){e!==this.simulationMode&&(this.simulationMode=e,this.initSimulation())},e.prototype.recurse=function(){if(this.canRecurse()){if("build"===this.simulationMode){var e=this.currNode;void 0===this.prevNode||this.prevNode===this.currNode.parent?this.currNode=void 0!==this.currNode.childLeft?this.currNode.childLeft:this.currNode.childRight:this.currNode=this.currNode.childRight,this.prevNode=e,this.focusNode(this.currNode),this.setNodeAncestorsVisible(this.currNode,!0)}else this.prevNode=this.currNode,this.queryLocation<this.currNode.median?this.currNode=this.currNode.childLeft:this.currNode=this.currNode.childRight,this.focusNode(this.currNode);this.notifyRecursionUpdate({currNode:this.currNode,prevNode:this.prevNode})}},e.prototype.canRecurse=function(){return"build"===this.simulationMode?void 0===this.prevNode||this.prevNode===this.currNode.parent?void 0!==this.currNode.childLeft||void 0!==this.currNode.childRight:this.prevNode===this.currNode.childLeft&&void 0!==this.currNode.childRight:void 0!==this.queryLocation&&this.queryLocation!==this.currNode.median&&(this.queryLocation<this.currNode.median?void 0!==this.currNode.childLeft:void 0!==this.currNode.childRight)},e.prototype.undoRecurse=function(){this.canUndoRecurse()&&("build"===this.simulationMode?(this.setSubtreeVisible(this.currNode,!1),this.currNode===this.currNode.parent.childRight&&void 0!==this.currNode.parent.childRight?this.prevNode=this.currNode.parent.childLeft:this.prevNode=this.currNode.parent.parent,this.currNode=this.currNode.parent,this.focusNode(this.currNode)):(this.currNode=this.prevNode,this.prevNode=this.currNode.parent,this.focusNode(this.currNode)),this.notifyRecursionUpdate({currNode:this.currNode,prevNode:this.prevNode}))},e.prototype.canUndoRecurse=function(){return("build"===this.simulationMode||void 0!==this.queryLocation)&&void 0!==this.currNode.parent},e.prototype.finishSubtree=function(){this.canFinishSubtree()&&("build"===this.simulationMode&&(this.setSubtreeVisible(this.currNode,!0),this.currNode===this.tree.root?(this.prevNode=void 0!==this.currNode.childRight?this.currNode.childRight:this.currNode.childLeft,this.focusNode(void 0)):(this.prevNode=this.currNode,this.currNode=this.currNode.parent,this.focusNode(this.currNode))),this.notifyRecursionUpdate({currNode:this.currNode,prevNode:this.prevNode}))},e.prototype.canFinishSubtree=function(){return"build"===this.simulationMode&&!(void 0===this.currNode.parent&&(this.prevNode===this.currNode.childLeft&&void 0===this.currNode.childRight||this.prevNode===this.currNode.childRight))},e.prototype.getMode=function(){return this.simulationMode},e.prototype.onHoverNode=function(e){this.hoverNodeEventListeners.push(e)},e.prototype.notifyHoverNodeEvent=function(e){for(var t=0,i=this.hoverNodeEventListeners;t<i.length;t++)(0,i[t])(e)},e.prototype.onRecursionUpdate=function(e){this.recursionUpdateListeners.push(e)},e.prototype.notifyRecursionUpdate=function(e){for(var t=0,i=this.recursionUpdateListeners;t<i.length;t++)(0,i[t])(e)},e.prototype.simulateQuery=function(e){"query"===this.getMode()&&(this.currNode=this.tree.root,this.prevNode=void 0,this.queryLocation=e,this.focusNode(this.tree.root),this.notifyRecursionUpdate({currNode:this.currNode,prevNode:this.prevNode}))},e}();e((function(){var t=new l,i=new c("plotboard"),o=e("#populate"),s={all:e("#algo-buttons button"),start:e("#algo-start"),recurse:e("#algo-recurse"),undoRecurse:e("#algo-undo-recurse"),finishSubtree:e("#algo-finish-subtree")},n=void 0;function d(e,t){if(s.recurse.prop("disabled",!e.canRecurse()),s.undoRecurse.prop("disabled",!e.canUndoRecurse()),s.finishSubtree.prop("disabled",!e.canFinishSubtree()),"build"===e.getMode())for(var o=0,n=e.tree.nodes;o<n.length;o++)void 0!==(h=n[o])&&i.setMedianVisible(h.median,e.graphNode(h).getAttribute("visible"));else{for(var d=function(o){var s,n=e.queryLocation;s=n<t.median?o.segmentsLeftSorted.filter((function(e){return r(e).left<=n})):n>t.median?o.segmentsLeftSorted.filter((function(e){return r(e).right>=n})):o.segmentsLeftSorted.slice(),i.addMedian(o.median,s,e.graphNode(o).getAttribute("strokeColor"),!0,o.median+"query")},h=t;void 0!==h;h=h.parent)d(h);for(var u=(1<<t.depth)-1+t.peerIdx+1;u<e.tree.nodes.length;u++)void 0!==(h=e.tree.nodes[u])&&i.removeMedian(h.median+"query")}}i.onNewSegment((function(){return s.start.prop("disabled",!1)})),o.on("submit",(function(t){i.populateSegments(parseInt(e("#populate-count").val())),t.preventDefault()})),t.onChange((function(e){"add"!==e&&(i.finalizeChanges(),o.find(":input").prop("disabled",!0))})),s.all.prop("disabled",!0),s.start.on("click",(function(){"add"===t.state&&0===i.getSegments().length||(e("[name=sort-endpoint]").prop("disabled",!1),"query"!==t.state?t.next():window.location.reload())})),t.onChange((function(e){switch(e){case"add":s.start.html("Start Building"),s.start.removeClass("btn-outline-danger"),s.start.addClass('btn-outline-primary"');break;case"build":s.start.html("Start Query"),s.start.removeClass("btn-outline-danger"),s.start.addClass('btn-outline-primary"');break;case"query":s.start.html("Reset"),s.start.removeClass('btn-outline-primary"'),s.start.addClass("btn-outline-danger")}})),i.setSortingEnd(e("[name=sort-endpoint]:checked").val()),e("[name=sort-endpoint]").each((function(t,o){e(o).on("change",(function(t){i.setSortingEnd(e(t.target).val())}))})).prop("disabled",!0),t.onChange((function(e){if("build"===e&&void 0===n){for(var o=0,r=(n=new f("treeboard",i.getSegments())).tree.nodes;o<r.length;o++)void 0!==(a=r[o])&&i.addMedian(a.median,a.segmentsLeftSorted,n.graphNode(a).getAttribute("color"));i.onQueryLineChange((function(e){for(var t=0,o=n.tree.nodes;t<o.length;t++){var r=o[t];void 0!==r&&i.removeMedian(r.median+"query")}null==n||n.simulateQuery(e)})),t.onChange((function(e){"add"!==e&&(null==n||n.setSimulationMode(e)),"query"===e&&i.showQueryLine()})),n.onHoverNode((function(e){void 0!==e.prevNode&&i.removeMedian("hover"),void 0!==e.node&&i.addMedian(e.node.median,e.node.segmentsLeftSorted,n.graphNode(e.node).getAttribute("highlightFillColor"),!0,"hover")})),n.onRecursionUpdate((function(e){return d(n,e.currNode)})),s.recurse.on("click",(function(){return n.recurse()})),s.undoRecurse.on("click",(function(){return n.undoRecurse()})),s.finishSubtree.on("click",(function(){return n.finishSubtree()})),d(n,n.tree.root)}else if("query"===e&&void 0!==n)for(var h=0,u=n.tree.nodes;h<u.length;h++){var a;void 0!==(a=u[h])&&i.setMedianVisible(a.median,!1)}}))}))})();