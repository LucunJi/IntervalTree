(()=>{"use strict";const t=jQuery,e=JXG;function i(t,e){return Math.random()*(e-t)+t}function o(t){return t.point1.coords.usrCoords[1]<t.point2.coords.usrCoords[1]?{left:t.point1,right:t.point2}:{left:t.point2,right:t.point1}}function s(t){var e=o(t);return{left:e.left.coords.usrCoords[1],right:e.right.coords.usrCoords[1],range:e.right.coords.usrCoords[1]-e.left.coords.usrCoords[1]}}function r(t,e){var i=o(t),s=i.left.coords.usrCoords[1];return e>i.right.coords.usrCoords[1]?-1:e<s?1:0}var n=function(){function t(){this.paletteIdx=0}return t.prototype.get=function(){var e=t.PALETTE[this.paletteIdx%t.PALETTE.length];return this.paletteIdx++,e},t.PALETTE=["#bc0101","#ffd700","#ea5f94","#ff7300","#11b716","#10d5a8","#0000ff","#9d02d7"],t}(),d="#0072b2",h="#c25010",u="#1f1f1f",a="#1f1f1f",c=function(){function t(t){var i=this;this.acceptChanges=!0,this.segments=[],this.sortingEnd="left",this.medians={},this.segmentVisibleMedians={},this.newSegmentListeners=[],this.startAddingSegmentFunction=function(t){if(!(i.board.getAllObjectsUnderMouse(t).length>0)){var e=i.board.getUsrCoordsOfMouse(t);i.creatingLine=i.newSegment(e,e)}},this.moveEndpointWhenAddingFunction=function(t){if(void 0!==i.creatingLine){var e=i.board.getUsrCoordsOfMouse(t);i.creatingLine.p1.setPosition(JXG.COORDS_BY_USER,[i.creatingLine.p1.coords.usrCoords[1],e[1]]),i.creatingLine.p2.setPosition(JXG.COORDS_BY_USER,e),i.board.update()}},this.releaseAddingSegmentFunction=function(){i.creatingLine=void 0},this.board=e.JSXGraph.initBoard(t,{boundingbox:[-10,10,10,-10],showCopyright:!1,showNavigation:!1,pan:{enabled:!1},zoom:{wheel:!1}}),this.board.on("down",this.startAddingSegmentFunction),this.board.on("move",this.moveEndpointWhenAddingFunction),this.board.on("up",this.releaseAddingSegmentFunction)}return t.prototype.newSegment=function(t,e){if(!this.acceptChanges)throw new Error("Board is frozen, new segments are not accepted.");var i=this.board.create("point",t,{withLabel:!1,color:h}),o=this.board.create("point",e,{withLabel:!1,color:h}),s=this.board.create("segment",[i,o],{strokeColor:d});return i.on("drag",(function(){return o.setPosition(JXG.COORDS_BY_USER,[o.coords.usrCoords[1],i.coords.usrCoords[2]])})),o.on("drag",(function(){return i.setPosition(JXG.COORDS_BY_USER,[i.coords.usrCoords[1],o.coords.usrCoords[2]])})),this.segments.push(s),this.segmentVisibleMedians[s.id]=[],this.notifyNewSegment(i,o,s),{p1:i,p2:o,l:s}},t.prototype.sortSegments=function(){for(var t=this,e=[],i=[],o=0;o<this.segments.length;o++)e.push(o);for("left"===this.sortingEnd?e.sort((function(e,i){return s(t.segments[e]).left-s(t.segments[i]).left})):e.sort((function(e,i){return s(t.segments[i]).right-s(t.segments[e]).right})),o=0;o<this.segments.length;o++)i[e[o]]=o;var r=18/(this.segments.length-1);for(o=0;o<this.segments.length;o++){var n=this.segments[o],d=9-r*i[o];n.point1.moveTo([n.point1.coords.usrCoords[1],d],400),n.point2.moveTo([n.point2.coords.usrCoords[1],d],400)}},t.prototype.finalizeChanges=function(){this.acceptChanges=!1,this.board.off("down",this.startAddingSegmentFunction),this.board.off("move",this.moveEndpointWhenAddingFunction),this.board.off("up",this.releaseAddingSegmentFunction);for(var t=0;t<this.segments.length;t++){var e=this.segments[t];this.board.suspendUpdate(),e.setAttribute({strokeColor:u,fixed:!0}),e.point1.setAttribute({color:a,fixed:!0}),e.point2.setAttribute({color:a,fixed:!0}),this.board.unsuspendUpdate()}this.sortSegments()},t.prototype.onNewSegment=function(t){this.newSegmentListeners.push(t)},t.prototype.notifyNewSegment=function(t,e,i){for(var o=0,s=this.newSegmentListeners;o<s.length;o++)(0,s[o])(t,e,i)},t.prototype.getSegments=function(){return this.segments},t.prototype.populateSegments=function(t){for(var e=18/(t-1),o=0;o<t;o++){var s=i(-9.5,8.74),r=i(s+.76,9.5),n=e*o-9;this.newSegment([s,n],[r,n])}},t.prototype.addMedian=function(t,e,i,o,s){void 0===o&&(o=!1),void 0===s&&(s=t),this.medians[s]={line:this.board.create("line",[[t,0],[t,1]],{strokeColor:i,dash:2,visible:!1,fixed:!0}),relatedSegments:e,color:i},this.setMedianVisibility(s,o)},t.prototype.removeMedian=function(t){this.setMedianVisibility(t,!1),this.board.removeObject(this.medians[t].line),delete this.medians[t]},t.prototype.setMedianVisibility=function(t,e){var i=this.medians[t];if(void 0!==i&&this.medians[t].line.getAttribute("visible")!==e){this.board.suspendUpdate(),i.line.setAttribute({visible:e});for(var o=0,s=i.relatedSegments;o<s.length;o++){var r=s[o];e?this.segmentVisibleMedians[r.id].push(t):this.segmentVisibleMedians[r.id]=this.segmentVisibleMedians[r.id].filter((function(e){return e!==t}));var n=this.segmentVisibleMedians[r.id],c=this.acceptChanges?d:u,l=this.acceptChanges?h:a;n.length>0&&(c=l=this.medians[n[n.length-1]].color),console.log(c,l,n),r.setAttribute({strokeColor:c}),r.point1.setAttribute({color:l}),r.point2.setAttribute({color:l})}this.board.unsuspendUpdate()}},t.prototype.setSortingEnd=function(t){this.sortingEnd!==t&&(this.sortingEnd=t,this.acceptChanges||this.sortSegments())},t}(),l=function(){function t(){this.state="add",this.listeners=[]}return t.prototype.onChange=function(t){this.listeners.push(t)},t.prototype.setState=function(t){if(this.state!==t){var e=this.state;this.state=t;for(var i=0,o=this.listeners;i<o.length;i++)(0,o[i])(t,e)}},t.prototype.next=function(){"add"===this.state?this.setState("build"):"build"===this.state&&this.setState("query")},t}(),p=function(){function t(t){this.nodes=[];var e=t.slice(),i=t.slice();e.sort((function(t,e){return o(t).left.coords.usrCoords[1]-o(e).left.coords.usrCoords[1]})),i.sort((function(t,e){return o(e).right.coords.usrCoords[1]-o(t).right.coords.usrCoords[1]})),this.root=this.makeNode(void 0,e,i,0),this.height=this.root.height}return t.prototype.makeNode=function(t,e,i,s){var n=e.length;if(0!==n){for(var d={parent:t,childLeft:void 0,childRight:void 0,depth:void 0===t?0:t.depth+1,height:1,peerIdx:s,median:0,segmentsLeftSorted:[],segmentsRightSorted:[]},h=0,u=n-1,a=0;a<n;){var c=h>=n?void 0:o(e[h]).left.coords.usrCoords[1],l=u<0?void 0:o(i[u]).right.coords.usrCoords[1];void 0===l||c<l?(d.median=c,h++):(d.median=l,u--),a++}for(var p=[],g=[],f=[],v=[],b=0,m=e;b<m.length;b++)((C=r(y=m[b],d.median))<0?p:C>0?f:d.segmentsLeftSorted).push(y);for(var N=0,S=i;N<S.length;N++){var y,C;((C=r(y=S[N],d.median))<0?g:C>0?v:d.segmentsRightSorted).push(y)}return d.childLeft=this.makeNode(d,p,g,2*s),d.childRight=this.makeNode(d,f,v,2*s+1),void 0!==d.childLeft&&(d.height=d.childLeft.height+1),void 0!==d.childRight&&(d.height=Math.max(d.height,d.childRight.height+1)),this.nodes[(1<<d.depth)-1+d.peerIdx]=d,d}},t}(),g=function(){function t(t,i){var o=this;this.nodes=[],this.edges=[],this.simulationMode="build",this.hoverNodeEventListeners=[],this.recursionUpdateListeners=[],this.board=e.JSXGraph.initBoard(t,{boundingbox:[-10,10,10,-10],showCopyright:!1,drag:{enabled:!1},pan:{enabled:!0,needShift:!1,needTwoFingers:!1},zoom:{wheel:!0,needShift:!1}}),this.tree=new p(i),this.drawTree(),this.initSimulation(),this.board.on("move",(function(){var t=o.hoveringNode;o.hoveringNode=void 0;for(var e=0;e<o.nodes.length;e++){var i=o.nodes[e];if(void 0!==i&&i.mouseover){o.hoveringNode=o.tree.nodes[e];break}}o.hoveringNode!==t&&o.notifyHoverNodeEvent({node:o.hoveringNode,prevNode:t})}))}return t.prototype.drawTree=function(){for(var t=this,e=16/(this.tree.height-1),i=this.tree.nodes.map((function(t,e){return void 0===t?void 0:e})).filter((function(t){return void 0!==t})).sort((function(e,i){return t.tree.nodes[e].median-t.tree.nodes[i].median})),o=[],s=new n,r=0,d=i;r<d.length;r++)o[l=d[r]]=s.get();for(var h=0;h<this.tree.height;h++)for(var u=8-h*e,a=1<<h,c=19/(a+1),l=0;l<a;l++){var p=a-1+l,g=[c*(l+1)-9.5,u];void 0!==this.tree.nodes[p]&&(this.nodes[p]=this.board.create("point",g,{size:.5,sizeUnit:"user",withLabel:!1,strokeWidth:4,color:o[p]}),p>0&&(this.edges[p]=this.board.create("line",[this.nodes[p],this.nodes[p-1>>>1]],{straightFirst:!1,straightLast:!1})))}},t.prototype.initSimulation=function(){"build"===this.simulationMode?(this.setNodeAncestorsVisible(this.tree.root,!0),this.setChildrenVisible(this.tree.root,!1),this.prevNode=void 0,this.currNode=this.tree.root,this.focusNode(this.currNode)):"query"===this.simulationMode&&this.setSubtreeVisible(this.tree.root,!0),this.notifyRecursionUpdate()},t.prototype.setNodeAncestorsVisible=function(t,e){for(var i,o;void 0!==t;){var s=(1<<t.depth)-1+t.peerIdx;null===(i=this.nodes[s])||void 0===i||i.setAttribute({visible:e}),null===(o=this.edges[s])||void 0===o||o.setAttribute({visible:e}),t=t.parent}},t.prototype.setChildrenVisible=function(t,e){this.setSubtreeVisible(null==t?void 0:t.childLeft,e),this.setSubtreeVisible(null==t?void 0:t.childRight,e)},t.prototype.setSubtreeVisible=function(t,e){var i,o;if(void 0!==t){var s=(1<<t.depth)-1+t.peerIdx;null===(i=this.nodes[s])||void 0===i||i.setAttribute({visible:e}),null===(o=this.edges[s])||void 0===o||o.setAttribute({visible:e}),this.setSubtreeVisible(t.childLeft,e),this.setSubtreeVisible(t.childRight,e)}},t.prototype.setNodeHollow=function(t,e){var i;void 0!==t&&(null===(i=this.graphNode(t))||void 0===i||i.setAttribute({fillOpacity:e?0:1}))},t.prototype.focusNode=function(t){this.setNodeHollow(this.focusedNode,!1),this.setNodeHollow(this.focusedNode=t,!0)},t.prototype.graphNode=function(t){return this.nodes[(1<<t.depth)-1+t.peerIdx]},t.prototype.setSimulationMode=function(t){t!==this.simulationMode&&(this.simulationMode=t,this.initSimulation())},t.prototype.recurse=function(){if(this.canRecurse()){if("build"===this.simulationMode){var t=this.currNode;void 0===this.prevNode||this.prevNode===this.currNode.parent?this.currNode=void 0!==this.currNode.childLeft?this.currNode.childLeft:this.currNode.childRight:this.currNode=this.currNode.childRight,this.prevNode=t,this.focusNode(this.currNode),this.setNodeAncestorsVisible(this.currNode,!0)}this.notifyRecursionUpdate()}},t.prototype.canRecurse=function(){return"build"===this.simulationMode&&(void 0===this.prevNode||this.prevNode===this.currNode.parent?void 0!==this.currNode.childLeft||void 0!==this.currNode.childRight:this.prevNode===this.currNode.childLeft&&void 0!==this.currNode.childRight)},t.prototype.undoRecurse=function(){this.canUndoRecurse()&&("build"===this.simulationMode&&(this.setSubtreeVisible(this.currNode,!1),this.currNode===this.currNode.parent.childRight&&void 0!==this.currNode.parent.childRight?this.prevNode=this.currNode.parent.childLeft:this.prevNode=this.currNode.parent.parent,this.currNode=this.currNode.parent,this.focusNode(this.currNode)),this.notifyRecursionUpdate())},t.prototype.canUndoRecurse=function(){return"build"===this.simulationMode&&void 0!==this.currNode.parent},t.prototype.finishSubtree=function(){this.canFinishSubtree()&&("build"===this.simulationMode&&(this.setSubtreeVisible(this.currNode,!0),this.currNode===this.tree.root?(this.prevNode=void 0!==this.currNode.childRight?this.currNode.childRight:this.currNode.childLeft,this.focusNode(void 0)):(this.prevNode=this.currNode,this.currNode=this.currNode.parent,this.focusNode(this.currNode))),this.notifyRecursionUpdate())},t.prototype.canFinishSubtree=function(){return"build"===this.simulationMode&&!(void 0===this.currNode.parent&&(this.prevNode===this.currNode.childLeft&&void 0===this.currNode.childRight||this.prevNode===this.currNode.childRight))},t.prototype.onHoverNode=function(t){this.hoverNodeEventListeners.push(t)},t.prototype.notifyHoverNodeEvent=function(t){for(var e=0,i=this.hoverNodeEventListeners;e<i.length;e++)(0,i[e])(t)},t.prototype.onRecursionUpdate=function(t){this.recursionUpdateListeners.push(t)},t.prototype.notifyRecursionUpdate=function(){for(var t=0,e=this.recursionUpdateListeners;t<e.length;t++)(0,e[t])()},t}();t((function(){var e=new l,i=new c("plotboard"),o=t("#populate"),s={all:t("#algo-buttons button"),start:t("#algo-start"),recurse:t("#algo-recurse"),undoRecurse:t("#algo-undo-recurse"),finishSubtree:t("#algo-finish-subtree")};function r(t){s.recurse.prop("disabled",!t.canRecurse()),s.undoRecurse.prop("disabled",!t.canUndoRecurse()),s.finishSubtree.prop("disabled",!t.canFinishSubtree());for(var e=0,o=t.tree.nodes;e<o.length;e++){var r=o[e];void 0!==r&&i.setMedianVisibility(r.median,t.graphNode(r).getAttribute("visible"))}}i.onNewSegment((function(){return s.start.prop("disabled",!1)})),o.on("submit",(function(e){i.populateSegments(parseInt(t("#populate-count").val())),e.preventDefault()})),e.onChange((function(t){"add"!==t&&(i.finalizeChanges(),o.find(":input").prop("disabled",!0))})),s.all.prop("disabled",!0),s.start.on("click",(function(){"add"===e.state&&0===i.getSegments().length||("query"!==e.state?e.next():window.location.reload())})),e.onChange((function(t){switch(t){case"add":s.start.html("Start Building"),s.start.removeClass("btn-outline-danger"),s.start.addClass('btn-outline-primary"');break;case"build":s.start.html("Start Query"),s.start.removeClass("btn-outline-danger"),s.start.addClass('btn-outline-primary"');break;case"query":s.start.html("Reset"),s.start.removeClass('btn-outline-primary"'),s.start.addClass("btn-outline-danger")}})),i.setSortingEnd(t("[name=sort-endpoint]:checked").val()),t("[name=sort-endpoint]").each((function(e,o){t(o).on("change",(function(e){i.setSortingEnd(t(e.target).val())}))})),e.onChange((function(t){if("build"===t){var o=new g("treeboard",i.getSegments());e.onChange((function(t){"add"!==t&&(null==o||o.setSimulationMode(t))}));for(var n=0,d=o.tree.nodes;n<d.length;n++){var h=d[n];void 0!==h&&i.addMedian(h.median,h.segmentsLeftSorted,o.graphNode(h).getAttribute("color"))}o.onHoverNode((function(t){void 0!==t.prevNode&&i.removeMedian("hover"),void 0!==t.node&&i.addMedian(t.node.median,t.node.segmentsLeftSorted,o.graphNode(t.node).getAttribute("highlightFillColor"),!0,"hover")})),o.onRecursionUpdate((function(){return r(o)})),s.recurse.on("click",(function(){return o.recurse()})),s.undoRecurse.on("click",(function(){return o.undoRecurse()})),s.finishSubtree.on("click",(function(){return o.finishSubtree()})),r(o)}}))}))})();